<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="author" content="Untree.co">
  <link rel="shortcut icon" href="../images/justtv.png">

  <meta name="description" content="" />
  <meta name="keywords" content="bootstrap, bootstrap4" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Source+Serif+Pro:wght@400;700&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="../css/bootstrap.min.css">
  <link rel="stylesheet" href="../css/owl.carousel.min.css">
  <link rel="stylesheet" href="../css/owl.theme.default.min.css">
  <link rel="stylesheet" href="../css/jquery.fancybox.min.css">
  <link rel="stylesheet" href="../fonts/icomoon/style.css">
  <link rel="stylesheet" href="../fonts/flaticon/font/flaticon.css">
  <link rel="stylesheet" href="../css/daterangepicker.css">
  <link rel="stylesheet" href="../css/aos.css">
  <link rel="stylesheet" href="../css/style.css">

  <title>Video Page</title>
</head>

<body>
  <nav class="site-nav">
    <div class="container">
      <div class="site-navigation">
        <a href="../index.html" class="logo m-0">Home</a>
        <!--     
            <ul class="js-clone-nav d-none d-lg-inline-block text-left site-menu float-right">
                <li class="active"><a href="index.html">Home</a></li>
            </ul> -->

        <a href="#" class="burger ml-auto float-right site-menu-toggle js-menu-toggle d-inline-block d-lg-none light"
          data-toggle="collapse" data-target="#main-navbar">
          <span></span>
        </a>

      </div>
    </div>
  </nav>
  <div class="hero">
    <!-- Maybe add image to top left corner -->
    <!-- <img src="../images/logonobackground.png" alt="Image"> -->
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-6 mx-auto text-center">
          <div class="intro-wrap">
            <h1 id="title" class="mb-0">${urlParams.get("name")}</h1>
            <p id="desc" class="text-white">Need to fix this part later to insert video metadata details </p>
          </div>
          <script>
            const urlParams = new URLSearchParams(window.location.search);
            const cid = urlParams.get('cid');
            const name = urlParams.get('name');
            const description = urlParams.get('description');
            
            fetch(`http://localhost:5001/collection?cid=${cid}`)
            .then(res=>res.json())
            .then(data=>{
                if (!data){
                  pass;
                }
                else{
                  data.forEach(element => {
                    var toAdd = `<li class="list-group-item">
                    <div class="row">
                      <div class="col">
                        1
                      </div>
                      <div class="col">
                        ${data.contributors}
                      </div>
                      <div class="col">
                        ${data.description}
                      </div>
                      <div class="col">
                        ${data.updatedAt}
                      </div>
                    </div>
                  </li>`;
                  })
                }
            });
            var title = document.querySelector('#title')
            title.innerText = name;
            var desc = document.querySelector('#desc')
            desc.innerText = description;


        </script>
        </div>
      </div>
    </div>
  </div>
  <br> <br>

  <!-- grid with header for what each colomn of this page means -->
  <!-- TO DO: fix the dimensions here oops -->
  <div class="container">
    <div class="row">
      <div class="col-sm-4">
        <h2>Version</h2>
      </div>
      <div class="col-sm-4">
        <h2>Contributor</h2>
      </div>
      <div class="col-sm-4">
        <h2>Commit Message</h2>
      </div>
      <div class="col-sm-4">
        <h2>Timestamp</h2>
      </div>
    </div>
  </div>

  <!-- grid containing actual info for each video -->
  <ul class="list-group">
    <!-- <li class="list-group-item">
      <div class="row">
        <div class="col">
          1
        </div>
        <div class="col">
          Jane Plane
        </div>
        <div class="col">
          Hey this is my commit message
        </div>
        <div class="col">
          October 12, 2022
        </div>
      </div>
    </li> -->
  </ul>
  <br><br>

  <!-- DIV containing pull and push buttons -->
  <div class="container">
    <div class="row">
      <div class="col">
        <div class="modal-footer">
          <!-- Change these to modals -->
          <button type="pull" id="pull-btn" class="btn btn-primary btn-block">Pull</button></a>
        </div>
      </div>
      <div class="col">
        <div class="modal-footer">
          <!-- Change these to modals -->
          <button type="push" id="push-btn" class="btn btn-primary btn-block">Push</button></a>
        </div>
      </div>
    </div>
  </div>

  <!-- Pull Modal -->
  <div id="pullModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content2">
      <div class="modal-header">
        <h2>Pull</h2>
        <span class="close" id="pullClose">&times;</span>
      </div>
      <div class="modal-body">
        <p>Select Project Version Number to Pull</p>
        <!-- <input type="text" class="form-control" placeholder="Enter art project name here..."> -->
        <p>
          <input type="radio" value="1.0.0" name="radio-group" checked>
          <label for="1.0.0">Version 1.0.0</label>
        </p>
        <p>
          <input type="radio" value="1.1.0" name="radio-group">
          <label for="1.1.0">Version 1.1.0</label>
        </p>
        <!-- Need to populate this dynamically later -->
      </div>
      <div class="modal-footer">
        <!-- Need to implement this button type -->
        <!-- Need to figure out how to initiate download here -->
        <a href="video.html">
          <button id="pull-pull" style="width: 100%;" class="btn btn-primary btn-block">Download Version</button>
        </a>
      </div>
    </div>
  </div>
  <!-- Push Modal -->
  <div id="pushModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content2">
      <div class="modal-header">
        <h2>Push</h2>
        <span class="close" id="pushClose">&times;</span>
      </div>
      <div class="modal-body">
        <input type="file" id="myFile" name="filename">
        <input type="text" id="author" class="form-control" placeholder="Author Name">
        <input type="text" id="version" class="form-control" placeholder="Version Number">
        <input type="text" id="commit" class="form-control" placeholder="Commit Description">
      </div>
      <div class="modal-footer">
        <!-- Need to implement this button type correctly -->
        <a href="video.html">
          <button id="push-push" style="width: 100%;" class="btn btn-primary btn-block">Push Art Commit</button>
        </a>
      </div>
    </div>
  </div>
  <script>
    // Get the modal
    var modal = document.getElementById("pullModal");
    var modal2 = document.getElementById("pushModal");

    // Get the button that opens the modal
    var btn = document.getElementById("pull-btn");
    var btn2 = document.getElementById("push-btn");
    var pullbtn = document.getElementById("pull-pull");
    var pushbtn = document.getElementById("push-push");

    // Get the <span> element that closes the modal
    var span = document.getElementById("pullClose");
    var span2 = document.getElementById("pushClose");

    var upload = document.getElementById("myFile");

    // When the user clicks the button, open the modal 
    btn.onclick = function () {
      modal.style.display = "block";
    }
    btn2.onclick = function () {
      modal2.style.display = "block";
    }
    pullbtn.onclick = function () {
      radioButtons = document.querySelectorAll('input[name="radio-group"]');
      let selectedVersion;
      for (const radioButton of radioButtons) {
        if (radioButton.checked) {
          selectedVersion = radioButton.value;
          break;
        }
      }
      console.log("Selected version: "+selectedVersion);
      // TO DO: retrieve selected version from database/estuary and display link/initiate download for user
    }
    pushbtn.onclick = function () {
      var author = document.getElementById('author').value
      var version = document.getElementById('version').value
      var commit = document.getElementById('commit').value
      console.log("Author: " + author + " Version: " + version + " Commit: " + commit);
      // TO DO: Handle the estuary stuff from here with CID and also pass into database
      const formData = new FormData();
      formData.append("data", e.target.files[0]);

      const urlParams = new URLSearchParams(window.location.search);
      const cid = urlParams.get('cid');
      const name = urlParams.get('name');
      const description = urlParams.get('description');
      
      // Estuary changes
      const xhr = new XMLHttpRequest();
      xhr.open(
        "POST",
        "https://upload.estuary.tech/content/add"
      );
      xhr.setRequestHeader(
        "Authorization",
        "Bearer ESTf9583d6f-1a54-4fa8-89d0-fb8e83a61793ARY" // CAN REPLACE THIS WITH API KEY
      );
      var output = xhr.send(formData);
      console.log(output);

      fetch(`http://localhost:5001/video?userName=${author}&name=${name}&description=${description}&coluuid=${cid}`,
      {
        method: "post",
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      })
        .then(res=>res.json())
        .then(data=>{
            data.forEach(element => {
                var name = element.name;
                var description = element.description;
                var uuid = element.uuid;
                var newCard = `<div class="col-4">
                <div class="card h-100">
                <img src="../images/thumbnails/generic_thumbnail.jpg" class="card-img-top" alt="...">
                <div class="card-body">
                    <h5 class="card-title">Project: ${name}</h5>
                    <p class="card-text">Description: ${description}</p>
                </div>
                <div class="card-footer">
                    <a class="btn" href="./html/video.html?cid=${uuid}&name=${name}&description=${description}">${uuid}</a>
                </div>
                </div>
                </div>`;
                allVids.innerHTML += newCard;

            });
        });
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function () {
      modal.style.display = "none";
    }
    span2.onclick = function () {
      modal2.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
      if (event.target == modal2) {
        modal2.style.display = "none";
      }
    }
    upload.onchange = function (e) {
      const formData = new FormData();
      formData.append("data", e.target.files[0]);

      const xhr = new XMLHttpRequest();

      xhr.open(
        "POST",
        "https://upload.estuary.tech/content/add"
      );
      xhr.setRequestHeader(
        "Authorization",
        "Bearer ESTf9583d6f-1a54-4fa8-89d0-fb8e83a61793ARY" // CAN REPLACE THIS WITH API KEY
      );
      var output = xhr.send(formData);
      console.log(output);
    }
  </script>
  <br>
  </div>
</body>